<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Usar C√≥digo</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Arial',sans-serif;}
    body{background:#0f0f1a;color:#fff;display:flex;flex-direction:column;align-items:center;padding:20px;text-align:center;}
    h1{font-size:1.8rem;margin:20px 0;color:#ff7a00;}
    .card{background:#1a1a2e;padding:20px;border-radius:15px;width:100%;max-width:420px;box-shadow:0 6px 15px rgba(0,0,0,0.5);margin-bottom:30px;}
    input{width:100%;padding:14px;margin:10px 0;border:none;border-radius:10px;font-size:1rem;text-align:center;}
    .btn{display:block;width:100%;padding:14px;margin:10px 0;border:none;border-radius:10px;font-size:1rem;font-weight:bold;cursor:pointer;transition:0.3s;}
    .btn-apply{background:#03dac6;color:#000;}
    .btn-apply:hover{opacity:0.9;}
    .btn-google{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:14px;margin:10px 0;border:none;border-radius:10px;font-size:1rem;font-weight:bold;cursor:pointer;transition:0.3s;background:#fff;color:#000;box-shadow:0 3px 6px rgba(0,0,0,0.2);}
    .btn-google img{width:20px;height:20px;}
    .btn-google:hover{background:#f1f1f1;}
    .toast{position:fixed;bottom:25px;left:50%;transform:translateX(-50%);background:#03dac6;color:#000;padding:12px 20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.5);font-weight:bold;animation:fadeIn 0.5s, fadeOut 0.5s 3s forwards;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
    @keyframes fadeOut{from{opacity:1;}to{opacity:0;}}
    .loader-container{display:none;flex-direction:column;align-items:center;margin-top:15px;gap:10px;}
    .loader{width:30px;height:30px;border:4px solid #444;border-top:4px solid #03dac6;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{100%{transform:rotate(360deg);}}
    .loader-text{font-size:0.9rem;color:#aaa;}
  </style>
</head>
<body>
  <h1>Usar C√≥digo üéüÔ∏è</h1>
  <div class="card">
    <p>Digite o c√≥digo de convite que voc√™ recebeu:</p>
    <input type="text" id="codigoInput" placeholder="Ex: VIP12345">
    <p style="margin-top:10px;font-size:0.9rem;color:#aaa;"> Logado como: <span id="emailUsuario">Nenhum</span> </p>
    <button class="btn-google" onclick="loginGoogle()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"/>
      <span>Entrar com Google</span>
    </button>
    <button class="btn btn-apply" onclick="aplicarCodigo()">Aplicar C√≥digo</button>
    <div class="loader-container" id="loaderBox">
      <div class="loader"></div>
      <div class="loader-text">Procurando no banco de dados. Aguarde...</div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, increment, arrayUnion, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // üî• Config do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDgDGmitCLvnLgmp2QZq8t92Np2Ojtqq8I",
      authDomain: "otk-animes-a6d2b.firebaseapp.com",
      projectId: "otk-animes-a6d2b",
      storageBucket: "otk-animes-a6d2b.firebasestorage.app",
      messagingSenderId: "896949212842",
      appId: "1:896949212842:web:69b21575085fb121ece2d3",
      measurementId: "G-VK841D7Z1C"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // fingerprint do dispositivo
    function getDeviceId(){
      const data = navigator.userAgent + screen.width + screen.height + navigator.language;
      return btoa(data).substring(0,20);
    }

    // Mostrar email do usu√°rio logado
    onAuthStateChanged(auth, (user) => {
      if(user){
        document.getElementById("emailUsuario").textContent = user.email;

        // üîó Redireciona de volta pro app com token + email
        user.getIdToken().then(token => {
          window.location.href = `meuapp://login?email=${encodeURIComponent(user.email)}&token=${token}`;
        });
      }
    });

    // üîë Login com Google
    async function loginGoogle(){
      const provider = new GoogleAuthProvider();
      try {
        await signInWithRedirect(auth, provider);
      } catch (error) {
        console.error(error);
        showToast("‚ùå Erro ao redirecionar login!");
      }
    }
    window.loginGoogle = loginGoogle;

    // Recupera login ap√≥s redirecionamento
    getRedirectResult(auth)
      .then((result) => {
        if(result && result.user){
          const user = result.user;
          document.getElementById("emailUsuario").textContent = user.email;
          showToast("‚úÖ Logado com Google: " + user.email);

          user.getIdToken().then(token => {
            window.location.href = `meuapp://login?email=${encodeURIComponent(user.email)}&token=${token}`;
          });
        }
      })
      .catch((error) => {
        console.error(error);
      });

    // Aplicar c√≥digo (mantive igual ao seu)
    async function aplicarCodigo(){
      const codigoUsado = document.getElementById("codigoInput").value.trim();
      const loaderBox = document.getElementById("loaderBox");

      if(codigoUsado === ""){
        showToast("‚ö†Ô∏è Digite um c√≥digo v√°lido!");
        return;
      }

      const user = auth.currentUser;
      if(!user){
        showToast("‚ö†Ô∏è Voc√™ precisa estar logado!");
        return;
      }

      const emailUsuario = user.email;
      const deviceId = getDeviceId();

      try {
        loaderBox.style.display = "flex"; 

        const ref = collection(db, "convide");
        const q = query(ref, where("codigo", "==", codigoUsado));
        const querySnapshot = await getDocs(q);

        loaderBox.style.display = "none";

        if(querySnapshot.empty){
          showToast("‚ùå C√≥digo n√£o encontrado!");
          return;
        }

        for(const docSnap of querySnapshot.docs){
          const data = docSnap.data();

          if(data.email === emailUsuario){
            showToast("‚ö†Ô∏è Voc√™ n√£o pode usar o pr√≥prio c√≥digo!");
            return;
          }

          if(data.usedBy && data.usedBy.includes(deviceId)){
            showToast("‚ö†Ô∏è Este dispositivo j√° usou esse c√≥digo!");
            return;
          }

          await updateDoc(doc(db, "convide", docSnap.id), {
            convidados: increment(1),
            usedBy: arrayUnion(deviceId)
          });

          await addDoc(collection(db, "CodigosUsados"), {
            codigo: codigoUsado,
            usadoPor: emailUsuario,
            donoDoCodigo: data.email,
            deviceId: deviceId,
            data: new Date().toISOString()
          });

          showToast("‚úÖ C√≥digo aplicado com sucesso!");
        }

      } catch (e) {
        loaderBox.style.display = "none";
        console.error(e);
        showToast("‚ùå Erro ao aplicar c√≥digo.");
      }
    }
    window.aplicarCodigo = aplicarCodigo;

    // Toast
    function showToast(msg){
      const toast=document.createElement('div');
      toast.className="toast";
      toast.innerText=msg;
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(),3500);
    }
  </script>
</body>
</html>